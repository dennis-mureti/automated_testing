name: Test

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    services: {}
    steps:
      - uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "16"

      - name: Install backend dependencies
        working-directory: backend
        run: |
          npm install
          npm rebuild sqlite3 --build-from-source

      - name: Run backend tests
        working-directory: backend
        run: |
          # Ensure sqlite3 is properly built for the CI environment
          npm rebuild sqlite3 --build-from-source
          npm test
        env:
          PORT: 3001

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm install

      - name: Run frontend tests
        working-directory: frontend
        run: npx playwright install && npx playwright test

      - name: Run Playwright UI tests
        working-directory: frontend
        run: |
          npx playwright install
          npx playwright test --ui
        env:
          CI: true

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-ui-report
          path: |
            frontend/test-results
            frontend/playwright-report
